От
11.10.2023

Получаем XLS файлы с сайта Политеха, разбираем их и сохраняем в структурированную базу данных.

Для парсинга XLS (не XLSX !) в питоне существует библиотека xlrd.


поехали!


Наша задача: получить полные данные о том:
	 какие группы, какие аудитории, в какое время, и кто проводит.
	 Кроме того, у каждого дня есть дата, месяц и номер недели (1, 2)

	Сохранить структурированном виде.
	В дальнейшем, может быть, мы захотим исправлять сокращённые названия предметов и имена преподавателей.

Соображение о подходе к программированию.

	Наши таблицы в политехе составляются вручную людьми, поэтому в них очень много различных отклонений от "стандарта".
	Идея в том чтобы создать такой парсер, который смог бы поддерживать не-программист (никто не знает, ЧТО придумают в учебном отделе через год или два).

	Предлагается сделать отдельный документ с небольшими шаблонами структурных кусков таблиц (ячеек для дисциплин), которые логически завершены и понятны человеку, и заставить парсер работать строго по этим шаблонам.
	При изменении элементов оформления в таблицах, всё что нужно будет сделать - это открыть шаблон и внести туда новый вариант форматирования, после чего парсер снова станет работать на 100%.

Ключевая идея разбора таблиц.

	Главную информация о структуре таблицы несут границы между ячейками, которые группируют их.
	Большое количество ячеек является объединёнными, и это неплохой признак для обнаружения элементов форматирования.

	Некоторые ячейки являются специальными, то есть несут особый смысл/роль. Например, это имена дней недели, названия месяцев, и граница - пустая строка между неделями (иногда там написано "2 неделя").
	От этих ячеек можно отталкиваться при разборе структуры большой таблицы.
	Полезно различать их по типам.

	Данные в таблице структурированы визуально, то есть, если одна ячейка находится напротив другой (по вертикали либо по горизонтали), то они, вероятно, связаны.
	Недостающую информацию можно получать, проходя "ладьёй" к ячейке нужного типа, и так сколько нужно раз.

	Типы ячеек будем определять по их содержимому и взаимному расположению.


Детали, замечания и подробности.

	Как обнаружилась при исследовании, граница ячеек может принадлежать только одной ячейке из двух, поэтому для адекватной работы с границами нужно проставлять границу обеим смежным ячейкам.

	Лекционные занятия частенько распространяются на несколько групп (по горизонтали).
		В связи с этим, шаблоны должны иметь возможность растягиваться по горизонтали.

	Некоторые занятия, как физическая культура, могут иметь общее название, но разных преподавателей в своих ячейках.
		В связи с этим нужно предусмотреть возможность ссылаться на растянутое название из нерастянутой ячейки.

	Структуры таблиц заметно различаются для разных факультетов и видов обучения.
	Например, в ВН_Магистратура_ЭТ-1в можно найти таблицу, у которой день недели слева от дней месяца, а не справа.
	Расписание в аспирантуре наверху имеет не группы, а предметы.
	Расписания консультаций внешне похожи на обычное расписание, но там нет времени и часов в структурном виде, - они пишутся внутри самой ячейки цифрами.
	Расписание НАЧИТКИ, например, имеет принципиально другую структуру.

	Название предмета/дисциплины чаще всего даётся заглавными буквами и помещается в отдельный объединённой ячейке.
	Но иногда название делится на несколько строк (ячеек).
	Иногда к названию добавляют дополнительную информацию, например, номер группы (в аспирантуре) и другое (всё это разделяется пробелами в рамках текста одной ячейки).

	вместо аудитории в элективных дисциплинах может стоять название в компании, в которой проводятся занятия ("ООО Лукойлинжиниринг" или "ПермНИПИнефть" -  причём на отдельных строках).

	В заголовке колонки таблицы может быть перечислено несколько групп, при этом общая часть может быть опущена: "ЭУЗ-581, 582,583" (см. ЗН_ФПИК 5 курс консультации).

	Все существенные изменения/коррективы обычно обозначаются в таблицах красным цветом.
	К примеру, перенос часов, а также перенос аудитории на конкретную дату.

	Выцеплять данные из текста ячеек предполагается регулярками, с использованием именованных захватывающих групп.




Пополняемый список всего того, что может относиться к элементу расписания:

обязательные поля:

	* дисциплина
	* группа / группы
	* учебные часы дня (или астрономическое время начала/конца занятия)
		(!) учебные часы могут быть написаны на ячейке, если её местоположение место занято и не соответствует им.
	* даты (день и месяц)
	* аудитория / аудитории
	* преподаватель / преподаватели (может быть пустым или стоять знаки "???"; могут быть указаны в разных ячейках или в одной через запятую)
		-> Несколько преподавателей и аудиторий могут быть сопоставлены друг другу (например, на иностранном языке).

не обязательные поля (но должны быть сохранены, если присутствуют; другими словами, шаблон может их ожидать, но если их не будет в реальной таблице,  это не нарушит применение шаблона)

	* фактические (явные) даты проведения (если занятие проводится раз в месяц, то даты указаны прямо в ячейке)
	* подгруппа
	* вид занятия - практика лекция лаба
	* количество часов занятия (возможно, избыточная информация)
	* признак дистанционного занятия
	* признак элективной дисциплины (может быть написано вне ячейки - снаружи)
	* жёлтый фон, обозначающий Тракторный район
	* другая информация (например, ссылка на зум)





[Устарело>>>]
обозначение сопоставления ячеек (вертикали или по горизонтали)

A <=> B  		занимают один и тот же диапазон (равны в этом измерении)
A >=  B  		A может быть шире, чем B, B полностью укладывается в диапазон A
A  =< B  		A может быть уже, чем B, A полностью укладывается в диапазон B

Возможно, тоже пригодятся:
A  >  B  		A должна быть шире, чем B, B полностью укладывается в диапазон A
A  <  B  		A должна быть уже, чем B, A полностью укладывается в диапазон B
A  --  B  		A и B имеют пересекающиеся диапазоны
[<<<Устарело]



Виды пространственных соотношений двух ячеек (в одном измерении -- в горизонтальной либо вертикальной проекции):

		--- снаружи ---

1) alpha << beta		на удалении, без примыкания
1) alpha >> beta		на удалении, без примыкания
1) alpha |1+| beta		на удалении, без примыкания

2) alpha | beta  		примыкают друг к другу краями
2) alpha |0| beta  		примыкают друг к другу краями


3) alpha || beta  		примыкают c возможностью отдаления
3) alpha |0+| beta  	примыкают c возможностью отдаления
3) alpha |*| beta  	примыкают c возможностью отдаления
3) !!! alpha > beta  	примыкают c возможностью отдаления
3) alpha >| beta  	примыкают c возможностью отдаления
3) alpha |< beta  	примыкают c возможностью отдаления
3) !!! alpha < beta  	примыкают c возможностью отдаления
3) alpha >|< beta  	примыкают c возможностью отдаления


4) alpha |2| beta  	находятся на расстоянии 2 ячейки
4) alpha |0..2| beta  	находятся на расстоянии не более 2 ячеек



		--- внутри ---

[ alpha ] beta 			alpha внутри beta, без доп. ограничений

[| alpha |] beta 		alpha и beta имеют совпадающие стенки (равны, накладываются)
alpha === beta 			alpha и beta имеют совпадающие стенки (равны, накладываются)

[<<alpha>>] beta  		alpha внутри beta, не примыкая к стенкам beta

alpha [<< beta >>]		beta внутри alpha, не примыкая к стенкам alpha

[ alpha >>] beta 		alpha внутри beta, примыкая к левой стенке beta обязательно, но не к правой

[0| alpha |0+] beta 	alpha внутри beta, примыкая к левой стенке beta обязательно, к правой - опционально

(x!)   alpha [< beta >]		beta внутри alpha, может примыкать к обеим стенкам alpha

[2+| alpha |2+] beta 	alpha внутри beta, расстояние до обеих стенок beta не менее 2




